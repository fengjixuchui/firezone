# Nginx configuration for Firezone's Phoenix app
#
# Generated by Chef

upstream phoenix {
  server <%= @phoenix['listen_address'] %>:<%= @phoenix['port'] %>;
}

<% if @nginx['cache']['enabled'] -%>
proxy_cache_path <%= @nginx['cache']['directory'] %>/firezone levels=1:2 keys_zone=firezone-cache:512m max_size=1000m inactive=600m;
proxy_temp_path  <%= @nginx['cache']['directory'] %>/tmp;

log_format cache '$remote_addr - [$time_local] "$request" $upstream_cache_status $upstream_response_time $upstream_status';
<% end %>

server {
  listen <%= @nginx['non_ssl_port'] %> default_server;
<% if @nginx['ipv6'] -%>
  listen [::]:<%= @nginx['non_ssl_port'] %> default_server;
<% end -%>
  server_name <%= @fqdn %>;
<% if @nginx['force_ssl'] -%>
  location / {
    <% if @nginx['enable_rate_limiting'] -%>
      limit_req zone=<%= @nginx['rate_limiting_zone_name'] %>;

    <% end -%>
    if ($http_x_forwarded_proto != 'https') {
      return 301 https://$server_name$request_uri;
    }
  }
}

server {
<% if @ssl['enabled'] -%>
  listen <%= @nginx['ssl_port'] %> default_server ssl;
  <% if @nginx['ipv6'] -%>
    listen [::]:<%= @nginx['ssl_port'] %> default_server ssl;
  <% end -%>
<% else -%>
  listen <%= @nginx['ssl_port'] %> default_server;
  <% if @nginx['ipv6'] -%>
    listen [::]:<%= @nginx['ssl_port'] %> default_server;
  <% end -%>
<% end -%>

  server_name <%= @fqdn %>;

<%   if @ssl['enabled'] -%>
  ssl_certificate <%= @ssl['certificate'] %>;
  ssl_certificate_key <%= @ssl['certificate_key'] %>;
  ssl_dhparam <%= @ssl['ssl_dhparam'] %>;
  ssl_prefer_server_ciphers on;
  ssl_ciphers <%= @fips_enabled ? @ssl['fips_ciphers'] : @ssl['ciphers'] %>;
  ssl_protocols <%= @ssl['protocols'] %>;
  ssl_session_cache <%= @ssl['session_cache'] %>;
  ssl_session_timeout <%= @ssl['session_timeout'] %>;
<%   end -%>
<% end -%>

<% if @nginx['redirect_to_canonical'] -%>
  set $redirect_to_canonical 0;

  # Redirect anything that isn't an ip address (for ELB checks) or the
  # canonical server name to <%= @fqdn %>
  if ($host !~* "^(<%= @fqdn.gsub('.', '\.') %>|[0-9.]+)$") {
    set $redirect_to_canonical H;
  }

  if ($redirect_to_canonical = H) {
    return 301 http<%= @nginx['force_ssl'] ? 's' : '' %>://<%= @fqdn %>$request_uri;
  }
<% end -%>

<% if @logging_enabled -%>
  <% if @nginx['cache']['enabled'] -%>
    access_log <%= @nginx['log_directory'] %>/cache.log cache;
  <% end -%>
<% end -%>

  location ~ /sitemap\d*.xml.gz {
    root <%= @app_directory %>/public;
    break;
  }

  location ~ ^/(assets|system)/ {
    root <%= @app_directory %>/public;
    expires 1y;
    add_header Cache-Control public;
    add_header ETag "";
    break;
  }

  location ~ ^/curry/ {
    return 410;
  }

<% if @nginx['cache']['enabled'] -%>
  # TODO: Is this useful to Firezone?
  location ~ ^/api/v1/cookbooks/.*/versions/.*(/download)?$ {
    proxy_set_header HOST $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Forwarded-Proto $http_x_forwarded_proto;
    proxy_pass http://phoenix;
    proxy_redirect off;

    proxy_ignore_headers Set-Cookie Cache-Control;
    proxy_buffering on;

    proxy_cache   firezone-cache;
    proxy_cache_valid   200 302 240m;
    proxy_cache_valid   any     5m;
    expires   240m;

    # to serve gzipped text and json responses
    gzip on;
    gzip_proxied expired no-cache no-store private auth;
  }
<% end -%>

  location ~ ^/live {
    proxy_pass http://phoenix;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }

  location ~ ^/socket {
    proxy_pass http://phoenix;
    proxy_http_version 1.1;
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";
  }

  location / {
    proxy_set_header HOST $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Forwarded-Proto https;
    proxy_pass http://phoenix;
    proxy_redirect off;

    # to serve gzipped text and json responses
    gzip on;
    gzip_min_length 1000;
    gzip_proxied expired no-cache no-store private auth;
    gzip_types text/plain application/json;
  }
}
